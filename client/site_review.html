<!doctype html>
<style>
.picBox{ max-height:400px; max-width:100%;}
caption{ font-size:10pt; font-family:'segoe UI'; }
figure{ font-size:12pt; font-family:'segoe UI'; font-weight:bold; }

.border-not {border-color:black; border-style:solid; border-width:1px;}
.photo-frame-not{ height:auto; border-color:black; border-style:solid; border-width:1px; padding-left:15px;  padding-top:15px;}
.photo-frame{ padding-left:5px; padding-top:15px;}
.photo-text{ padding-left:5px; padding-top:15px;}

.photo-image{ max-height:300px; padding-left:5px; float:left;}
.break-line {margins:auto;}
@media print {
	.row {page-break-inside:avoid; !important;}
	.control-joint {page-break-inside:auto; !important;}
}

</style>
<script type='text/javascript'>

// site visit report object - svr
var svr={};
svr.refresh=function(result, delta){
	//console.log("SVR_ID", localStorage.getItem("svr_id"))
	$.ajax({
		contentType: "application/x-www-form-urlencoded; charset=UTF-8",
		data: $.param({
			action:"SVR-SELECT",
			project_id:localStorage.getItem("project_id"),
			svr_id:localStorage.getItem("svr_id")
		}),
		error: function(err){ console.log(err.message);},
		success: function(result){
			console.log("SVR-SUCCESS");
			
			var i, index=0; r=result.svrs[0];
			
			//result={svrs[{}],}
			//reformat result to suit comments template
			var rows=[];
			rows.push({section_heading:true, txt:"General Notes", section_num:1, section_index:0});
			index+=1;
			for (i in r.generals){
				rows.push({
					index:index, txt:r.generals[i],
					section_item:true, section:"generals", section_num:1, section_index:Number(i)
				}); 
				index+=1;
			}
			rows.push({
				section_heading:true, txt:"Comments & Observations",
				section_num:2, section_index:0
			});
			index+=1;
			for (i in r.comments){
				rows.push({
					index:index, txt:r.comments[i], 
					section_item:true, section:"comments", section_num:2, section_index:Number(i)
				});
				index+=1;
			}
			rows.push({section_heading:true, txt:"Closed Issues", section_num:3, section_index:0});
			index+=1;
			for (i in r.issuesx){
				rows.push({
					index:i, txt:r.issuesx[i], 
					section_item:true,  section:"issuesx", section_num:3, section_index:Number(i)
				});
				index+=1;
			}
			rows.push({section_heading:true, txt:"Open Issues", section_num:4, section_index:0});
			index+=1;
			for (i in r.issues){
				rows.push({
					index:i, txt:r.issues[i],
					section_item:true,  section:"issues", section_num:4, section_index:Number(i)
				});
				index+=1;
			}
			
			//keep copy of rows for editing
			svr.comments.rows=rows;
			
			//reformat result for photos template...
			rows=[];		
			r=result.svrs[0].xdata; // {img01:{caption:"", date:"", format:"", path:"..."}, ...}
			var done=false; //done flag 
			var cc=0; //column counter
			var row=[]; //either an image frame or caption  
			for (i in r){
				if(r[i].format=="landscape") {
					if (cc > 6) {rows.push(row); row=[]; cc=0;}
					row.push({fig:true, cap:r[i].caption, col:"col-xs-1"})
					row.push({img:r[i].path, col:"col-xs-5"});
					cc+=6;
				} else if (r[i].format=="portrait") {
					if (cc > 8) {rows.push(row); row=[]; cc=0;}
					row.push({fig:true, cap:r[i].caption, col:"col-xs-1"})					
					row.push({img:r[i].path, col:"col-xs-3"});
					cc+=4;
				} else if (r[i].format=="wide") {
					if (cc > 1) {rows.push(row); row=[]; cc=0;}
					row.push({fig:true, cap:r[i].caption, col:"col-xs-1"})
					row.push({img:r[i].path, col:"col-xs-11"});
					cc+=12;				
				}
			};			
			rows.push(row); //last push
			//keep track of rows
			svr.photos.rows=rows;

			//render
			$("#svr-titleblock-right-placeholder").html(svr.titleblock.template_right({svr:r}));
			$("#svr-comments-placeholder").html(svr.comments.template({rows:svr.comments.rows}));
			$("#svr-photos-placeholder").html(svr.photos.template({rows:svr.photos.rows}));
		},
		type:"POST",
		url:"/uploads"
	});
};

// text editor
svr.ed=new casbah.Editor();
// highligher
svr.hi=new casbah.Highlighter("highlite");

///////////////////////
// Site visit report
svr.comments={};
svr.comments.onclick=function(el){
	svr.ed.text(el, function(){
		svr.comments.update(svr.ed.row(), svr.ed.rowid(), true);
		svr.ed.hide();
	});
};

svr.comments.ondragstart=function(el, ev){
	//ev.dataTransfer.setData("text/plain", "comment_id:"+$(el).attr("index"));
	//note that "Text" argument is required by iexplorer...
	ev.dataTransfer.setData("Text", 
		"svr_index:"+$(el).attr("index") + " svr_section_num:"+$(el).attr("section_num")
	);
	
};

svr.comments.ondrop=function(el, ev){
	console.log("DROP...");
	//var txt=ev.dataTransfer.getData("text/plain");
	//note that "Text" argument is required by iexplorer...
	var tx=ev.dataTransfer.getData("Text");
	var a1=tx.indexOf("svr_index:");
	var a2=tx.indexOf("svr_section_num:");
	var sc=[1,1,1,1]; //section counters for refactoring
	console.log("a1, a2:",a1, a2);
	if ( a1 > -1 && a2 > -1){
		//from row index
		var fi=tx.slice(a1+"svr_index:".length).split(/\s+/)[0];
		//to row index
		var ti=$(el).attr("index");
		if (fi!=ti){
			//proceed only if from and to indexes are different
			//change section_num to that of section where dropped
			svr.comments.rows[fi].section_num=svr.comments.rows[ti].section_num;
			//move it
			casbah.array_nth_to_nth(svr.comments.rows, fi, ti);
			//refactor indexes
			for (var i in svr.comments.rows){
				svr.comments.rows[i].index=i;
				svr.comments.rows[i].section_index=sc[svr.comments.rows[i].section_num];
				sc[svr.comments.rows[i].section_num]+=1;
			}		
			//render
			$("#svr-comments-placeholder").html(svr.comments.template({rows:svr.comments.rows}));
			
			//svr.update();
			//svr.refresh();
		}
	} else if (tx.length>0){
		/**
		//console.log("Text:", txt, " Type:", (typeof txt), " length:", txt.length);
		svr.comments.tv.add( function(r){
			console.log("new rowid", r.rowid, "Ti:", ti); 
			//update comment_id list in 
			//TO DO Create array function like this but where ti arg is the index in list not value to match.
			//this would allow droping payload next to target element, not at end of list
			casbah.array_insert_after($PP.$comment_ids, r.rowid, ti);
			//update the report table (using parameters), then don't refresh
			svr.tv.save({comment_ids:$PP.$comment_ids}, $PP.$rowid);
			//added row has default value so change to match current row by
			//updating the comments table, then refresh (3rd arg is true)
			svr.comments.tv.save({"comment":txt}, r.rowid, true);
		});
		***/
	}	

};

svr.comments.insert=function(el){
	/**
	svr.comments.tv.add( function(r){
		//update comment_id list in parameters object
		casbah.array_insert_after($PP.$comment_ids, r.rowid, svr.hi.rowid());
		//update the report table (using parameters), then don't refresh
		svr.tv.save({comment_ids:$PP.$comment_ids}, $PP.$rowid);
		//update the comments table, then refresh (true) to show change
		svr.comments.tv.save(svr.hi.row(), r.rowid, true);
	});
	*/
};
svr.comments.menu=$("#svr-comments-menu").menu().css("position","absolute", "width", "200px").hide();
svr.comments.remove=function(el){
	/**
	//CTV.remove(hi.rowid()); 
	//only remove comment rowid from comment list in report, comment remains in comment table
	//console.log("remove comment_ids, rowid:",$PP.$comment_ids, svr.hi.rowid());
	casbah.array_remove($PP.$comment_ids, svr.hi.rowid());
	//console.log("remove ", $PP.$comment_ids);
	svr.update({comment_ids:$PP.$comment_ids}, $PP.$rowid);
	svr.comments.tv.refresh();
	*/
};
svr.comments.template=Handlebars.compile($("#svr-comments-template").html());
svr.comments.update=function(row, rowid){
	console.log("comments update ROWID:\n", rowid, "ROW:\n",row)
};


/////////////////
// PHOTOS
svr.photos={}
svr.photos.template=Handlebars.compile($("#svr-photos-template").html());

/////////////
// titleblock
svr.titleblock={};
svr.titleblock.refresh=function(){
	//console.log("PROJECT SELECT");
	//var svr_id=localStorage.getItem("svr_id");
	
	$.ajax({
		contentType: "application/x-www-form-urlencoded; charset=UTF-8",
		data: $.param({
			action:"PROJECT-SELECT",
			//select info for this project only...
			project_id:localStorage.getItem("project_id")
		}),
		error: function(err){ console.log("Error", err);},
		success: function(result){
			$("#svr-titleblock-left-placeholder").html(svr.titleblock.template_left(result));
		},
		type:"POST",
		url:"/uploads"
	});
};

svr.titleblock.template_left=Handlebars.compile($("#svr-titleblock-left").html());
svr.titleblock.template_right=Handlebars.compile($("#svr-titleblock-right").html());


///////////////////////////////////////
// Render page header and titleblock 
$.get("client/header.html", function(htm){
	//console.log('tbh loaded:', htm);
	if (typeof svr.header=="undefined"){svr.header={};}
	svr.header.template=Handlebars.compile(htm);
	$("#svr-header").html(svr.header.template({doc_type:"Site Visit Review"}));
});



///////////////////////////////////////
// Render page 
svr.titleblock.refresh();
svr.refresh();

</script>

<!-- PAGE STARTS HERE -->

<div class="container">
	<div id="svr-header">placeholder</div>
	<div class="row">
	<div id="svr-titleblock-left-placeholder" class="col-xs-6">titleblock - project info placeholder</div>
	<div id="svr-titleblock-right-placeholder" class="col-xs-6">titleblock - report info placeholder</div>
	</div>
	
	<p class="row row_" >This report is a general review of progress and construction activities on site.  Architectural Work was visually reviewed on a random basis for general conformity with Architectural Contract Documents prepared by this firm.  Refer also to Mechanical and Electrical field reports issued separately.  
	</p>
	<br><br>
	<div id="svr-comments-placeholder" class="marz"></div>
	<div id="svr-photos-placeholder" class="marz"></div>
	<br><br>
</div>


<!-- TEMPLATES -->
<template id='svr-titleblock-left' type="text/x-handlebars-template">
{{#each projects}}
<div class="row row__">
	<strong class="col-xs-4">Project No.:</strong>
	<p class="col-xs-8">{{project_id}}</p>
</div>

<div class="row row_">
	<strong class="col-xs-4">Project Name:</strong>
	<p class="col-xs-8">{{project_name}}</p>
</div>

<div class="row row_">
	<strong class="col-xs-4">Project Address:</strong>
	<p class="col-xs-8">{{address}}</p>
</div>

<div class="row row_">
	<strong class="col-xs-4">Contractor:</strong>
	<p class="col-xs-8">{{contractor}}</p>
</div>

<div class="row row_">
	<strong class="col-xs-4">Permit No.:</strong>
	<p id="svr-permit" class="col-xs-8">{{permit}}</p>
</div>
{{/each}}
</template>

<template id='svr-titleblock-right' type="text/x-handlebars-template">
{{#with svr}}
<div class="row row__">
	<strong class="col-xs-4">Report No.:</strong>
	<p id="svr-id" class="col-xs-8">{{svr_id}}</p>
</div>

<div class="row row_">
	<strong class="col-xs-4">Title:</strong>
	<p id="svr-title" class="col-xs-8">{{title}}</p>
</div>

<div class="row row_">
	<strong id="svr-date" class="col-xs-4">Date of Visit:</strong>
	<p class="col-xs-8">{{date}}</p>
</div>

<div class="row row_">
	<strong  class="col-xs-4">Date Issued:</strong>
	<p id="svr-date-issued" class="col-xs-8">{{date_issued}}</p>
</div>

<div class="row row_">
	<strong  class="col-xs-4">By:</strong>
	<p id="svr-author" class="col-xs-8">{{author}}</p>
</div>
{{/with}}
</template>


<template id='svr-comments-template' type="text/x-handlebars-template">

	{{#each rows as |row rowindex|}}
	{{#if row.section_heading}}
	<div class="row marz" 
		index="{{row.index}}"
		section_num="{{row.section_num}}"
		section_index="{{row.section_index}}"
		onmouseenter="svr.hi.light(this)"
		oncontextmenu="casbah.showMenu(svr.comments.menu, event)">
		<h3 class="col-xs-1 marz" >{{row.section_num}}</h3>
		<h3 class="col-xs-10 border-left marz">{{row.txt}}</h3>
		<h3 class="col-xs-1 marz" >&nbsp;</h3>
	</div>	
	{{/if}}
	{{#if row.section_item}}	
	<div class="row marz"
		index="{{row.index}}"
		section_num="{{row.section_num}}"
		section_index="{{row.section_index}}"
		draggable="true"
		ondragstart="svr.comments.ondragstart(this, event)"
		ondragover="event.preventDefault()"
		ondrop="svr.comments.ondrop(this, event)"
		onmouseenter="svr.hi.light(this)"
		oncontextmenu="casbah.showMenu(svr.comments.menu, event)">
	<p 	class="col-xs-1 marz">{{row.section_num}}.{{plusOne row.section_index}}</p>
	<p 	index="{{row.index}}"
		section="{{row.section}}"
		onclick="svr.comments.onclick(this)"
		class="col-xs-10 border-left marz">{{row.txt}}</p>	
	<p 	class="col-xs-1 marz">&nbsp;</p>	
	</div>
	{{/if}}
	{{/each}}
	
</template>


<template id='svr-photos-template' type="text/x-handlebars-template">

	<div class="row marz" 
		onmouseenter="svr.hi.light(this)"
		oncontextmenu="casbah.showMenu(svr.photo.menu, event)">
		<h3 class="col-xs-1 marz" >5.0</h3>
		<h3 class="col-xs-10 border-left marz">Photos</h3>
		<h3 class="col-xs-1 marz" >&nbsp;</h3>
	</div>
	
	{{#each rows as |row ri|}}
	<div class="row marz">
	{{#each row as |item ii|}}
	{{#if item.img}}
	<div class="{{item.col}} photo-frame border" onclick="svr.photos.onclick(this)">
		<img class="photo-image" src="{{item.img}}">
	</div>
	{{/if}}
	{{#if item.fig}}
	<div class="{{item.col}} photo-text border">
		<figure style="display:inline;">5.{{@index}}</figure>
		<caption>{{item.cap}}</caption>
	</div>
	{{/if}}
	{{/each}}	
	</div>
	<div class="control-joint"></div>
	{{/each}}

	
</template>



<!-- MENUS -->
<div id="svr-comments-menu" onmouseleave="svr.comments.menu.hide()" class="hide9999">
	<p onclick="svr.comments.remove()">Delete</p>
	<p onclick="svr.comments.insert()">Insert</p>
	<p onclick="svr.comments.menu.hide()">Exit</p>
	<p onclick="svr.refresh();svr.comments.menu.hide()">Refresh</p>
</div>

